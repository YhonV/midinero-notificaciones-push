import { Injectable, Logger } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import * as admin from 'firebase-admin';

// Â¡IMPORTANTE! Pega aquÃ­ el contenido de tu archivo .json de credenciales
// MÃ¡s adelante lo haremos de forma segura con variables de entorno en Render.
// eslint-disable-next-line @typescript-eslint/no-var-requires
const serviceAccount = require('../mi-dinero-58798-firebase-adminsdk-fbsvc-56a8a8358b.json');

@Injectable()
export class TasksService {
  private readonly logger = new Logger(TasksService.name);

  constructor() {
    // Inicializamos Firebase Admin solo una vez
    if (admin.apps.length === 0) {
      admin.initializeApp({
        credential: admin.credential.cert(serviceAccount),
      });
    }
  }

  @Cron('0 19 * * *', { timeZone: 'America/Santiago' }) // Todos los dÃ­as a las 19:00
  async handleCron() {
    this.logger.debug('Ejecutando recordatorio diario...');

    const tokensSnapshot = await admin.firestore().collection('fcm_tokens').get();
    if (tokensSnapshot.empty) {
      this.logger.log('No se encontraron tokens.');
      return;
    }

    const tokens = tokensSnapshot.docs.map((doc) => doc.id);
    this.logger.log(`Enviando notificaciÃ³n a ${tokens.length} tokens.`);

    const payload = {
      notification: {
        title: 'ğŸ”” Â¡Es hora de tu recordatorio!',
        body: 'No olvides completar tu tarea diaria. Â¡TÃº puedes!',
      },
    };

    await admin.messaging().sendEachForMulticast({ tokens, ...payload });

    // AquÃ­ podrÃ­as aÃ±adir la lÃ³gica para limpiar tokens invÃ¡lidos si quieres.
  }
}